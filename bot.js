const { Telegraf, Markup } = require('telegraf');
require('dotenv').config();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
const bot = new Telegraf(process.env.BOT_TOKEN);

// URL Mini App
const MINI_APP_URL = process.env.FRONTEND_URL || 'https://eed58e0935c7.ngrok-free.app';

console.log('ü§ñ nFactorial Adventures Bot (Telegraf) started');
console.log('üîó Mini App URL:', MINI_APP_URL);

// Middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
bot.use((ctx, next) => {
    const start = Date.now();
    return next().then(() => {
        const ms = Date.now() - start;
        console.log(`‚ö° ${ctx.updateType} from ${ctx.from?.username || ctx.from?.first_name} (${ms}ms)`);
    });
});

// –ö–æ–º–∞–Ω–¥–∞ /start
bot.start(async (ctx) => {
    const firstName = ctx.from.first_name || '–°—Ç—É–¥–µ–Ω—Ç';
    
    const welcomeMessage = `üéÆ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ nFactorial Adventures!**

–ü—Ä–∏–≤–µ—Ç, ${firstName}! üëã

–≠—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞-—Å–∏–º—É–ª—è—Ç–æ—Ä —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–π –∂–∏–∑–Ω–∏ –≤ nFactorial Bootcamp! –¢—ã –ø—Ä–æ–π–¥–µ—à—å –≤—Å–µ 10 –Ω–µ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∏—è, –±—É–¥–µ—à—å —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å–∞–º–∏, –∫–æ–¥–∏—Ç—å, –æ–±—â–∞—Ç—å—Å—è —Å –º–µ–Ω—Ç–æ—Ä–∞–º–∏ –∏ –ø–µ—Ä–µ–∂–∏–≤–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–∏–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è.

üéØ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –∏–≥—Ä—ã:**
‚òï –£–ø—Ä–∞–≤–ª—è–π –∫–æ—Ñ–µ, –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π, –∑–Ω–∞–Ω–∏—è–º–∏ –∏ —Å–Ω–æ–º
üíª –ö–æ–¥—å –Ω–∞ React, JavaScript –∏ –¥—Ä—É–≥–∏—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö  
üë®‚Äçüè´ –û–±—â–∞–π—Å—è —Å –º–µ–Ω—Ç–æ—Ä–∞–º–∏ –∏ –ø–æ–ª—É—á–∞–π —Å–æ–≤–µ—Ç—ã
üè¢ –ò—Å—Å–ª–µ–¥—É–π –ª–æ–∫–∞—Ü–∏–∏ nFactorial
üèÜ –°–æ–±–∏—Ä–∞–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ø–æ–¥–Ω–∏–º–∞–π—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ

üì± **–ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ 2D –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞!**
–ü—Ä–æ—Å—Ç–æ –æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Å—è –∏ –∫–ª–∏–∫–∞–π –Ω–∞ –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

üöÄ –ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å —Å–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –º–∏—Ä nFactorial?`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üéÆ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É!', MINI_APP_URL)],
        [
            Markup.button.callback('üìö –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã', 'rules'),
            Markup.button.callback('üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥', 'leaderboard')
        ],
        [Markup.button.callback('‚ùì –ü–æ–º–æ—â—å', 'help')]
    ]);

    try {
        await ctx.replyWithPhoto(
            { source: './nfact.png' },
            {
                caption: welcomeMessage,
                parse_mode: 'Markdown',
                ...keyboard
            }
        );
    } catch (error) {
        console.error('‚ùå Error sending photo:', error);
        // Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await ctx.reply(welcomeMessage, {
            parse_mode: 'Markdown',
            ...keyboard
        });
    }
});

// –ö–æ–º–∞–Ω–¥–∞ /game
bot.command('game', async (ctx) => {
    const gameMessage = `üéÆ **nFactorial Adventures**

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üöÄ –ò–≥—Ä–∞—Ç—å —Å–µ–π—á–∞—Å!', MINI_APP_URL)],
        [
            Markup.button.callback('üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', 'stats'),
            Markup.button.callback('üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è', 'achievements')
        ]
    ]);

    try {
        await ctx.replyWithPhoto(
            { source: './nfact.png' },
            {
                caption: gameMessage,
                parse_mode: 'Markdown',
                ...keyboard
            }
        );
    } catch (error) {
        console.error('‚ùå Error sending photo:', error);
        await ctx.reply(gameMessage, {
            parse_mode: 'Markdown',
            ...keyboard
        });
    }
});

// –ö–æ–º–∞–Ω–¥–∞ /help
bot.help(async (ctx) => {
    const helpMessage = `‚ùì **–ü–æ–º–æ—â—å –ø–æ nFactorial Adventures**

**–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:**
/start - –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
/game - –û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É  
/help - –≠—Ç–∞ –ø–æ–º–æ—â—å
/stats - –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/leaderboard - –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤

**–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**
1. üëÄ **–û—Å–º–∞—Ç—Ä–∏–≤–∞–π—Å—è** - –∏–∑—É—á–∞–π –ª–æ–∫–∞—Ü–∏–∏
2. ü§è **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π** - –∫–ª–∏–∫–∞–π –Ω–∞ –æ–±—ä–µ–∫—Ç—ã
3. üö∂ **–ü–µ—Ä–µ–º–µ—â–∞–π—Å—è** - —Ö–æ–¥–∏ –º–µ–∂–¥—É –ª–æ–∫–∞—Ü–∏—è–º–∏
4. ‚öñÔ∏è **–£–ø—Ä–∞–≤–ª—è–π —Ä–µ—Å—É—Ä—Å–∞–º–∏** - —Å–ª–µ–¥–∏ –∑–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏

**–†–µ—Å—É—Ä—Å—ã:**
‚òï **–ö–æ—Ñ–µ** - —ç–Ω–µ—Ä–≥–∏—è –¥–ª—è –∫–æ–¥–∏–Ω–≥–∞
üí™ **–ú–æ—Ç–∏–≤–∞—Ü–∏—è** - –∂–µ–ª–∞–Ω–∏–µ —É—á–∏—Ç—å—Å—è  
üß† **–ó–Ω–∞–Ω–∏—è** - —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
üò¥ **–°–æ–Ω** - –æ—Ç–¥—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

**–õ–æ–∫–∞—Ü–∏–∏ nFactorial:**
üè´ –£—á–µ–±–Ω—ã–π –∫–ª–∞—Å—Å
üè¢ –ö–æ–≤–æ—Ä–∫–∏–Ω–≥ –∑–æ–Ω–∞
üåü –ì–ª–∞–≤–Ω—ã–π —Ö–æ–ª–ª
‚òï –ö–∞—Ñ–µ nFactorial

–£–¥–∞—á–∏ –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏! üöÄ`;

    await ctx.reply(helpMessage, { parse_mode: 'Markdown' });
});

// –ö–æ–º–∞–Ω–¥–∞ /stats
bot.command('stats', async (ctx) => {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const statsMessage = `üìä **–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

üéÆ –ò–≥—Ä—ã —Å—ã–≥—Ä–∞–Ω–æ: 0
‚è±Ô∏è –í—Ä–µ–º—è –≤ –∏–≥—Ä–µ: 0 –º–∏–Ω
üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: 0/25
üìä –û—á–∫–∏: 0

üèÖ –¢–≤–æ–π —Ä–∞–Ω–≥: –ù–æ–≤–∏—á–æ–∫ üå±

üí° –ù–∞—á–Ω–∏ –∏–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üéÆ –ò–≥—Ä–∞—Ç—å —Å–µ–π—á–∞—Å!', MINI_APP_URL)]
    ]);

    await ctx.reply(statsMessage, {
        parse_mode: 'Markdown',
        ...keyboard
    });
});

// –ö–æ–º–∞–Ω–¥–∞ /leaderboard
bot.command('leaderboard', async (ctx) => {
    const leaderboardMessage = `üèÜ **–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ nFactorial Adventures**

1. üëë @student1 - 10,250 –æ—á–∫–æ–≤
2. ü•à @coder_pro - 8,900 –æ—á–∫–æ–≤  
3. ü•â @react_master - 7,650 –æ—á–∫–æ–≤
4. üèÖ @js_ninja - 6,420 –æ—á–∫–æ–≤
5. üèÖ @frontend_guru - 5,880 –æ—á–∫–æ–≤

*–¢–≤–æ–µ –º–µ—Å—Ç–æ –±—É–¥–µ—Ç –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∏–≥—Ä—ã!*

üí° –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –æ—á–∫–∏:
‚Ä¢ –ö–æ–¥—å –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö (+50)
‚Ä¢ –û–±—â–∞–π—Å—è —Å –º–µ–Ω—Ç–æ—Ä–∞–º–∏ (+30)
‚Ä¢ –í—ã–ø–æ–ª–Ω—è–π –ø—Ä–æ–µ–∫—Ç—ã (+100-1000)
‚Ä¢ –°–æ–±–∏—Ä–∞–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (+100)`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üöÄ –ü–æ–¥–Ω—è—Ç—å—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!', MINI_APP_URL)]
    ]);

    await ctx.reply(leaderboardMessage, {
        parse_mode: 'Markdown',
        ...keyboard
    });
});

// ===== CALLBACK HANDLERS =====

// –ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã
bot.action('rules', async (ctx) => {
    await ctx.answerCbQuery();
    
    const rulesMessage = `üìö **–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã nFactorial Adventures**

**–¶–µ–ª—å:** –ü—Ä–æ–π—Ç–∏ –≤—Å–µ 10 –Ω–µ–¥–µ–ª—å bootcamp –∏ —Å—Ç–∞—Ç—å –∫—Ä—É—Ç—ã–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º!

**–ü—Ä–∞–≤–∏–ª–∞:**
1. üìä –°–ª–µ–¥–∏ –∑–∞ —Ä–µ—Å—É—Ä—Å–∞–º–∏ - –Ω–µ –¥–∞–≤–∞–π –∏–º —É–ø–∞—Å—Ç—å –¥–æ –Ω—É–ª—è
2. ‚è∞ –£–ø—Ä–∞–≤–ª—è–π –≤—Ä–µ–º–µ–Ω–µ–º - –¥–µ–Ω—å, –≤–µ—á–µ—Ä, –Ω–æ—á—å –≤–ª–∏—è—é—Ç –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å  
3. üéØ –í—ã–ø–æ–ª–Ω—è–π –∑–∞–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–µ–∫—Ç—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π
4. ü§ù –û–±—â–∞–π—Å—è —Å –º–µ–Ω—Ç–æ—Ä–∞–º–∏ –¥–ª—è –º–æ—Ç–∏–≤–∞—Ü–∏–∏
5. ‚òï –ü–µ–π –∫–æ—Ñ–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏
6. üò¥ –û—Ç–¥—ã—Ö–∞–π –≤ –∫–∞—Ñ–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–Ω–∞

**–ü–æ–±–µ–¥–∞:** –ó–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ 10 –Ω–µ–¥–µ–ª—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞–≤—ã–∫–∞–º–∏!

**–®—Ç—Ä–∞—Ñ—ã:**
- –†–µ—Å—É—Ä—Å = 0 ‚Üí –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π
- –ü–ª–æ—Ö–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º ‚Üí —Å–Ω–∏–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–£–¥–∞—á–∏, –±—É–¥—É—â–∏–π —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫! üíª`;

    await ctx.editMessageText(rulesMessage, { parse_mode: 'Markdown' });
});

// –õ–∏–¥–µ—Ä–±–æ—Ä–¥
bot.action('leaderboard', async (ctx) => {
    await ctx.answerCbQuery('üèÜ –û—Ç–∫—Ä—ã–≤–∞—é –ª–∏–¥–µ—Ä–±–æ—Ä–¥...');
    
    const leaderboardMessage = `üèÜ **–¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤ nFactorial Adventures**

1. üëë @student1 - 10,250 –æ—á–∫–æ–≤
2. ü•à @coder_pro - 8,900 –æ—á–∫–æ–≤  
3. ü•â @react_master - 7,650 –æ—á–∫–æ–≤
4. üèÖ @js_ninja - 6,420 –æ—á–∫–æ–≤
5. üèÖ @frontend_guru - 5,880 –æ—á–∫–æ–≤

*–¢–≤–æ–µ –º–µ—Å—Ç–æ –±—É–¥–µ—Ç –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∏–≥—Ä—ã!*

üí° –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –æ—á–∫–∏:
‚Ä¢ –ö–æ–¥—å –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö (+50)
‚Ä¢ –û–±—â–∞–π—Å—è —Å –º–µ–Ω—Ç–æ—Ä–∞–º–∏ (+30)
‚Ä¢ –í—ã–ø–æ–ª–Ω—è–π –ø—Ä–æ–µ–∫—Ç—ã (+100-1000)
‚Ä¢ –°–æ–±–∏—Ä–∞–π –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (+100)`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üöÄ –ü–æ–¥–Ω—è—Ç—å—Å—è –≤ —Ä–µ–π—Ç–∏–Ω–≥–µ!', MINI_APP_URL)]
    ]);

    await ctx.editMessageText(leaderboardMessage, {
        parse_mode: 'Markdown',
        ...keyboard
    });
});

// –ü–æ–º–æ—â—å
bot.action('help', async (ctx) => {
    await ctx.answerCbQuery('‚ùì –û—Ç–∫—Ä—ã–≤–∞—é –ø–æ–º–æ—â—å...');
    
    const helpMessage = `‚ùì **–ü–æ–º–æ—â—å –ø–æ nFactorial Adventures**

**–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:**
/start - –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
/game - –û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É  
/help - –≠—Ç–∞ –ø–æ–º–æ—â—å
/stats - –¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
/leaderboard - –¢–æ–ø –∏–≥—Ä–æ–∫–æ–≤

**–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**
1. üëÄ **–û—Å–º–∞—Ç—Ä–∏–≤–∞–π—Å—è** - –∏–∑—É—á–∞–π –ª–æ–∫–∞—Ü–∏–∏
2. ü§è **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–π** - –∫–ª–∏–∫–∞–π –Ω–∞ –æ–±—ä–µ–∫—Ç—ã
3. üö∂ **–ü–µ—Ä–µ–º–µ—â–∞–π—Å—è** - —Ö–æ–¥–∏ –º–µ–∂–¥—É –ª–æ–∫–∞—Ü–∏—è–º–∏
4. ‚öñÔ∏è **–£–ø—Ä–∞–≤–ª—è–π —Ä–µ—Å—É—Ä—Å–∞–º–∏** - —Å–ª–µ–¥–∏ –∑–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏

**–†–µ—Å—É—Ä—Å—ã:**
‚òï **–ö–æ—Ñ–µ** - —ç–Ω–µ—Ä–≥–∏—è –¥–ª—è –∫–æ–¥–∏–Ω–≥–∞
üí™ **–ú–æ—Ç–∏–≤–∞—Ü–∏—è** - –∂–µ–ª–∞–Ω–∏–µ —É—á–∏—Ç—å—Å—è  
üß† **–ó–Ω–∞–Ω–∏—è** - —Ç–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å
üò¥ **–°–æ–Ω** - –æ—Ç–¥—ã—Ö –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

**–õ–æ–∫–∞—Ü–∏–∏ nFactorial:**
üè´ –£—á–µ–±–Ω—ã–π –∫–ª–∞—Å—Å
üè¢ –ö–æ–≤–æ—Ä–∫–∏–Ω–≥ –∑–æ–Ω–∞
üåü –ì–ª–∞–≤–Ω—ã–π —Ö–æ–ª–ª
‚òï –ö–∞—Ñ–µ nFactorial

–£–¥–∞—á–∏ –≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏! üöÄ`;

    await ctx.editMessageText(helpMessage, { parse_mode: 'Markdown' });
});

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
bot.action('stats', async (ctx) => {
    await ctx.answerCbQuery('üìä –ó–∞–≥—Ä—É–∂–∞—é —Ç–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...');
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    const statsMessage = `üìä **–¢–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

üéÆ –ò–≥—Ä—ã —Å—ã–≥—Ä–∞–Ω–æ: 0
‚è±Ô∏è –í—Ä–µ–º—è –≤ –∏–≥—Ä–µ: 0 –º–∏–Ω
üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–π: 0/25
üìä –û—á–∫–∏: 0

üèÖ –¢–≤–æ–π —Ä–∞–Ω–≥: –ù–æ–≤–∏—á–æ–∫ üå±

üí° –ù–∞—á–Ω–∏ –∏–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É!`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üéÆ –ò–≥—Ä–∞—Ç—å —Å–µ–π—á–∞—Å!', MINI_APP_URL)]
    ]);

    await ctx.editMessageText(statsMessage, {
        parse_mode: 'Markdown',
        ...keyboard
    });
});

// –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
bot.action('achievements', async (ctx) => {
    await ctx.answerCbQuery('üèÜ –ó–∞–≥—Ä—É–∂–∞—é –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è...');
    
    const achievementsMessage = `üèÜ **–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è nFactorial Adventures**

**–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è (25):**

üå± **–ü–µ—Ä–≤—ã–µ —à–∞–≥–∏:**
‚Ä¢ –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ - –í–æ–π—Ç–∏ –≤ –∏–≥—Ä—É
‚Ä¢ –ü–µ—Ä–≤—ã–π –∫–æ—Ñ–µ - –í—ã–ø–∏—Ç—å –∫–æ—Ñ–µ 
‚Ä¢ –ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –º–µ–Ω—Ç–æ—Ä–æ–º - –ü–æ–≥–æ–≤–æ—Ä–∏—Ç—å —Å –º–µ–Ω—Ç–æ—Ä–æ–º

üíª **–û–±—É—á–µ–Ω–∏–µ:**
‚Ä¢ –ü–µ—Ä–≤—ã–π –∫–æ–¥ - –ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–¥ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
‚Ä¢ –ó–Ω–∞–Ω–∏—è = —Å–∏–ª–∞ - –î–æ—Å—Ç–∏—á—å 100 –∑–Ω–∞–Ω–∏–π
‚Ä¢ –°–µ—Ä–µ–¥–∏–Ω–∞ –ø—É—Ç–∏ - –î–æ—Å—Ç–∏—á—å 5 —É—Ä–æ–≤–Ω—è

üöÄ **–ü—Ä–æ–µ–∫—Ç—ã:**
‚Ä¢ –ü–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç - –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
‚Ä¢ –ú–∞—Å—Ç–µ—Ä –ø—Ä–æ–µ–∫—Ç–æ–≤ - –ó–∞–≤–µ—Ä—à–∏—Ç—å 10 –ø—Ä–æ–µ–∫—Ç–æ–≤

‚òï **–ü—Ä–µ–¥–∞–Ω–Ω–æ—Å—Ç—å:**
‚Ä¢ –ö–æ—Ñ–µ–º–∞–Ω - –í—ã–ø–∏—Ç—å 100 —á–∞—à–µ–∫ –∫–æ—Ñ–µ
‚Ä¢ –°–æ–≤–∞ - –ò–≥—Ä–∞—Ç—å –Ω–æ—á—å—é

‚≠ê **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ:**
‚Ä¢ –ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏—Å—Ç - –ò–¥–µ–∞–ª—å–Ω–∞—è –Ω–µ–¥–µ–ª—è
‚Ä¢ –õ–µ–≥–µ–Ω–¥–∞ nFactorial - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å

üéÆ –ù–∞—á–Ω–∏ –∏–≥—Ä–∞—Ç—å, —á—Ç–æ–±—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å!`;

    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üéØ –ù–∞—á–∞—Ç—å –æ—Ö–æ—Ç—É –∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏!', MINI_APP_URL)]
    ]);

    await ctx.editMessageText(achievementsMessage, {
        parse_mode: 'Markdown',
        ...keyboard
    });
});

// ===== –¢–ï–ö–°–¢–û–í–´–ï –°–û–û–ë–©–ï–ù–ò–Ø =====

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('text', async (ctx) => {
    const text = ctx.message.text;
    
    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    if (text.startsWith('/')) return;
    
    const responses = [
        'üéÆ –ì–æ—Ç–æ–≤ –∏–≥—Ä–∞—Ç—å –≤ nFactorial Adventures? –ù–∞–∂–º–∏ /game',
        'üíª –•–æ—á–µ—à—å —Å—Ç–∞—Ç—å –∫—Ä—É—Ç—ã–º —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º? –ù–∞—á–Ω–∏ –∏–≥—Ä—É!',
        '‚òï –í—Ä–µ–º—è –¥–ª—è –∫–æ–¥–∏–Ω–≥–∞! –ó–∞–ø—É—Å–∫–∞–π –∏–≥—Ä—É –∫–æ–º–∞–Ω–¥–æ–π /start',
        'üöÄ nFactorial –∂–¥–µ—Ç —Ç–µ–±—è! –ò—Å–ø–æ–ª—å–∑—É–π /help –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å'
    ];
    
    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
    
    const keyboard = Markup.inlineKeyboard([
        [Markup.button.webApp('üéÆ –ò–≥—Ä–∞—Ç—å!', MINI_APP_URL)]
    ]);
    
    await ctx.reply(randomResponse, keyboard);
});

// ===== –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –ö–û–ú–ê–ù–î–´ =====

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
bot.command('debug', async (ctx) => {
    const debugInfo = `üîß **Debug Info**

ü§ñ Bot: Running
üåê Server: ${MINI_APP_URL}
üë§ User: ${ctx.from.username || ctx.from.first_name}
üí¨ Chat ID: ${ctx.chat.id}
‚è∞ Time: ${new Date().toLocaleString('ru-RU')}

‚úÖ All systems operational!`;

    await ctx.reply(debugInfo, { parse_mode: 'Markdown' });
});

// –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
bot.command('admin', async (ctx) => {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ –∞–¥–º–∏–Ω–∞
    const adminMessage = `üë®‚Äçüíº **–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å**

üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:
‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 0
‚Ä¢ –ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ: 0  
‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: ${Math.floor(process.uptime() / 60)} –º–∏–Ω

üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π:
‚Ä¢ Restart server: /restart
‚Ä¢ View logs: /logs
‚Ä¢ Send announcement: /announce`;

    await ctx.reply(adminMessage, { parse_mode: 'Markdown' });
});

// ===== ERROR HANDLING =====

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
bot.catch(async (err, ctx) => {
    console.error('‚ùå Bot error:', err);
    
    try {
        await ctx.reply('üòì –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start');
    } catch (replyError) {
        console.error('‚ùå Error sending error message:', replyError);
    }
});

// Graceful shutdown
process.once('SIGINT', () => {
    console.log('üõë Received SIGINT, stopping bot...');
    bot.stop('SIGINT');
});

process.once('SIGTERM', () => {
    console.log('üõë Received SIGTERM, stopping bot...');
    bot.stop('SIGTERM');
});

// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
const startBot = async () => {
    try {
        await bot.launch();
        console.log('‚úÖ Bot started successfully!');
        console.log(`üîó @${bot.botInfo?.username || 'unknown'} is running`);
    } catch (error) {
        console.error('‚ùå Failed to start bot:', error);
        process.exit(1);
    }
};

// –≠–∫—Å–ø–æ—Ä—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ server.js
module.exports = { bot, startBot }; 